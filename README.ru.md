# Загрузчик для STM32F407VET6 (проект для STM32CubeIDE v1.19.0)

Данный загрузчик предназначен для записи программ через Ethernet (W5500).

## Настройки подключения

- **IP‑адрес:** `10.0.28.60`
- **Маска подсети:** `255.255.0.0`
- **Порт:** `5555`
- **Протокол:** UDP

## Требования к использованию

1. ПК и устройство, на котором требуется обновить прошивку, должны находиться в одной подсети.
2. Основная программа должна быть скомпилирована в формате `.bin` и иметь размер не более **480 КБ** (загрузчик занимает **32 КБ** Flash‑памяти).
3. Для активации загрузчика необходимо заземлить ножку **PB1**.

## Схема подключения W5500

| STM32F407VET6 | W5500 |
|--------------|-------|
| PB15         | MOSI  |
| PB14         | MISO  |
| PB13         | SCK   |
| PB12         | CS    |
| PD0          | RST   |

## Обмен данными

### Шаг 1. Отправка команд загрузчику

После запуска загрузчик принимает две команды:

- `0xAA` — байт синхронизации. Запускает процедуру подготовки Flash‑памяти к записи новой прошивки.
- `0xDD` — стирание старой прошивки без записи новой.

**Ответы загрузчика:**
- `0xBB` — успешное завершение подготовки/стирания. Загрузчик готов принимать пакеты с новой прошивкой.
- `0xCC` — ошибка очистки памяти. Можно повторно отправить синхробайт (`0xAA`).

> **Примечание:** Ответы на команду `0xDD` аналогичны ответам на `0xAA`, но после стирания загрузчик не ожидает пакетов с прошивкой.

### Шаг 2. Передача прошивки

После получения `0xBB` можно передавать пакеты с прошивкой. Формат пакета:

- `0x01/0xFF/DATA_LEN_H/DATA_LEN_L/DATA`


- `0x01` — заголовок (данные для загрузчика).
- `0xFF` — код (передача прошивки).
- `DATA_LEN_H` и `DATA_LEN_L` — два байта, указывающие длину данных.
- `DATA` — часть прошивки (1024 байт).

### Шаг 3. Передача контрольной суммы CRC

Последний пакет содержит контрольную сумму CRC, рассчитанную для файла прошивки:

- `0x01/0xEE/CRC_H/CRC_L`


- `0x01` — заголовок (данные для загрузчика).
- `0xEE` — код (передача контрольной суммы).
- `CRC_H` и `CRC_L` — два байта контрольной суммы.

**Ответы загрузчика после проверки CRC:**
- `0xE2` — успешное обновление. Загрузчик закрывает интерфейсы и переходит к основной программе.
- `0xE1` — ошибка обновления. Загрузчик возвращается к ожиданию синхробайта.
- `0xE0` — неизвестная ошибка.

## Программирование микроконтроллера

Загрузчик записывается в микроконтроллер:
- с помощью **STM32CubeIDE** и программатора **ST‑LINK V2**;
- либо через **STM32CubeProgrammer** и программатор.

**Адреса записи:**
- Загрузчик: `0x08000000`
- Основная программа: `0x08008000`

**Важно:**
- В скрипте линкера должен быть указан правильный адрес.
- В основной программе необходимо перенести вектор прерываний.